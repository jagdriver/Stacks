
version: '3.7'

services:
  traefik:
    image: traefik:v2.1.1
    command:
      # This section is for Docker provider
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      # This section is for File provider
      - "--providers.file"
      - "--providers.file.filename=traefik.yml"
      - "--providers.file.directory=/opt/containers/traefik/data"
      - "--providers.file.watch=true"

    ports:
      - 80:80
      - 443:443
      - 8210:8210
      - 8211:8211

    volumes:
      - /opt/containers/traefik/data/traefik.yml:/traefik.yml:ro
      - /opt/containers/traefik/data/acme.json:/acme.json
      - /var/log/traefik:/log
      - /var/run/docker.sock:/var/run/docker.sock:ro

    networks:
      - traefik-public

    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    labels:
      # This section is for local http
      - "traefik.enable=true"
      - "traefik.http.routers.local.rule=Host(`traefik.wavesnake.local`)"
      - "traefik.http.routers.local.entrypoints=web"
      - "traefik.http.routers.local.service=api@internal"
      - "traefik.http.routers.local.middlewares=traefik-auth"

      # This section is for external http
      - "traefik.http.routers.api.rule=Host(`traefik.wavesnake.dk`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=manager:$$apr1$$ktr40m5i$$IPyM/4bfex8WbfpmsNl.9."

      # This section is for external https
      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.api.middlewares=traefik-https-redirect"
      - "traefik.http.routers.traefik-secure.entrypoints=secure"
      - "traefik.http.routers.traefik-secure.rule=Host(`traefik.wavesnake.dk`)"
      - "traefik.http.routers.traefik-secure.middlewares=traefik-auth"
      - "traefik.http.routers.traefik-secure.tls=true"
      - "traefik.http.routers.traefik-secure.tls.certresolver=http"
      - "traefik.http.routers.traefik-secure.service=api@internal"

networks:
  traefik-public:
    external: true